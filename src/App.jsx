import { useState, useEffect } from 'react'
import { initTelegramWebApp } from './utils/telegram'
import PhotoUploader from './components/PhotoUploader'
import StyleSelector from './components/StyleSelector'
import GenerateButton from './components/GenerateButton'
import LoadingSpinner from './components/LoadingSpinner'
import ResultCard from './components/ResultCard'
import { generateCard } from './services/api'
import './App.css'

const CARD_STYLES = [
  {
    id: 'newyear',
    name: '–ù–æ–≤–æ–≥–æ–¥–Ω—è—è',
    emoji: 'üéÑ',
    prompt: '–°–æ–∑–¥–∞–π –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –æ—Ç–∫—Ä—ã—Ç–∫—É —Å—Ç—Ä–æ–≥–æ –≤ —Å—Ç–∏–ª–µ —Å–æ–≤–µ—Ç—Å–∫–∏—Ö –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—Ç–∫—Ä—ã—Ç–æ–∫ –°–°–°–† 1950‚Äì1970-—Ö –≥–æ–¥–æ–≤, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –¥–æ—Å–ª–æ–≤–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—è –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞. –°—Ç–∏–ª—å –æ—Ç–∫—Ä—ã—Ç–∫–∏ –¥–æ–ª–∂–µ–Ω –∫–∞–∂–¥—ã–π —Ä–∞–∑ –±—Ä–∞—Ç—å—Å—è –¢–û–õ–¨–ö–û –∏–∑ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ó–∞–ø—Ä–µ—â–µ–Ω—ã –ª—é–±—ã–µ –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –≤–∞—Ä–∏–∞—Ü–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è. –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ —Å—Ç–∏–ª—é (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ): —Å—Ç–∏–ª—å, –ø–∞–ª–∏—Ç—Ä–∞, –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ç–µ–∫—Å—Ç—É—Ä—ã, –º–∞–∑–∫–∏, —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏, –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π, –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, —Å—Ç–µ–ø–µ–Ω—å —Ä–µ–∞–ª–∏–∑–º–∞, –∑–µ—Ä–Ω–∏—Å—Ç–æ—Å—Ç—å, —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, ¬´—Å–æ–≤–µ—Ç—Å–∫–∏–π –¥—É—Ö¬ª. –í—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1 –≤ 1 –∫–∞–∫ –≤ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–µ. –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–∞–∂–¥—ã–π —Ä–∞–∑, –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ / –ª–∏—Ü–æ, —Å—Ç–∏–ª—å, –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –ø–æ–¥–∞—á–∞ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏. –≠—Å—Ç–µ—Ç–∏–∫–∞ –∏ –∞—Ç—Ä–∏–±—É—Ç–∏–∫–∞ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π): —Å–æ–≤–µ—Ç—Å–∫–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –Ω–æ–≤–æ–≥–æ–¥–Ω—è—è –æ—Ç–∫—Ä—ã—Ç–∫–∞, –≤–∏–Ω—Ç–∞–∂–Ω–∞—è –±—É–º–∞–≥–∞, —ç—Ñ—Ñ–µ–∫—Ç —Å—Ç–∞—Ä–æ–π –ø–µ—á–∞—Ç–∏, —Ç—ë–ø–ª–∞—è, —Å–ª–µ–≥–∫–∞ –≤—ã—Ü–≤–µ—Ç—à–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞, –º—è–≥–∫–∏–π —Å–≤–µ—Ç –±–µ–∑ –∂—ë—Å—Ç–∫–∏—Ö —Ç–µ–Ω–µ–π, –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ä–∞–º–∫–∞ –ø–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É, –∑–∏–º–Ω–∏–π –ª–µ—Å, –µ–ª–∏ –Ω–∞ —Ñ–æ–Ω–µ, —Ö–≤–æ–π–Ω—ã–µ –≤–µ—Ç–∫–∏, —à–∏—à–∫–∏, —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ —ë–ª–æ—á–Ω—ã–µ –∏–≥—Ä—É—à–∫–∏ —Å–æ–≤–µ—Ç—Å–∫–æ–≥–æ —Ç–∏–ø–∞, –∫—Ä–∞—Å–Ω—ã–µ, —Å–∏–Ω–∏–µ –∏ –∑–æ–ª–æ—Ç—ã–µ —à–∞—Ä—ã, –ø–∞–¥–∞—é—â–∏–π —Å–Ω–µ–≥, —Å–Ω–µ–∂–∏–Ω–∫–∏, –ª–µ—Å–Ω—ã–µ –∂–∏–≤–æ—Ç–Ω—ã–µ –≤ —Å–∫–∞–∑–æ—á–Ω–æ–º —Å—Ç–∏–ª–µ: –∑–∞–π—á–∏–∫, –±–µ–ª–∫–∞, –∂–∏–≤–æ—Ç–Ω—ã–µ –¥–µ—Ä–∂–∞—Ç —ë–ª–æ—á–Ω—ã–µ —É–∫—Ä–∞—à–µ–Ω–∏—è, –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –ª–µ–Ω—Ç—ã, –≤–∏–Ω—Ç–∞–∂–Ω–∞—è –Ω–∞–¥–ø–∏—Å—å ¬´–° –ù–æ–≤—ã–º –≥–æ–¥–æ–º!¬ª –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç–∫–∏. –ü–µ—Ä—Å–æ–Ω–∞–∂ –∏ –æ–¥–µ–∂–¥–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∏–ª—è): –ø–æ—Ä—Ç—Ä–µ—Ç –ø–æ –≥—Ä—É–¥—å –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏, –º–µ—Ö–æ–≤–∞—è —à–∞–ø–∫–∞, –º–µ—Ö–æ–≤–∞—è –∏–ª–∏ —Ç—ë–ø–ª–∞—è –∑–∏–º–Ω—è—è –æ–¥–µ–∂–¥–∞, –≤—è–∑–∞–Ω—ã–π —à–∞—Ä—Ñ, —Å–æ–≤–µ—Ç—Å–∫–∞—è –∑–∏–º–Ω—è—è —ç—Å—Ç–µ—Ç–∏–∫–∞, –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –≤–∏–Ω—Ç–∞–∂–Ω—ã–π –≤–∏–¥. –õ–ò–¶–û ‚Äî –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢. –ó–∞–º–µ–Ω–∏—Ç—å –ª–∏—Ü–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ –ª–∏—Ü–æ —Å –º–æ–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: 100% —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–æ—ë —Ä–µ–∞–ª—å–Ω–æ–µ –ª–∏—Ü–æ, —Ç–æ—á–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, —Ñ–æ—Ä–º–∞ —á–µ—Ä–µ–ø–∞, –Ω–æ—Å, –≥—É–±—ã, –≥–ª–∞–∑–∞, –ø–æ–ª–Ω–æ–µ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ, –±–µ–∑ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –ª–∏—Ü–∞ –ø–æ–¥ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é, –±–µ–∑ —É–ª—É—á—à–µ–Ω–∏–π, –æ–º–æ–ª–æ–∂–µ–Ω–∏—è, ¬´–∫—Ä–∞—Å–∏–≤–æ—Å—Ç–µ–π¬ª, –∫–æ–∂–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è, –∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ, –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª—ë–≥–∫–∞—è —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ–¥ –æ–±—â–∏–π —Å—Ç–∏–ª—å, –ª–∏—Ü–æ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫, –±—É–¥—Ç–æ –µ–≥–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤–ø–∏—Å–∞–ª–∏ –≤ –≥–æ—Ç–æ–≤—É—é —Å–æ–≤–µ—Ç—Å–∫—É—é –æ—Ç–∫—Ä—ã—Ç–∫—É. –§–∏–Ω–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∏–ª—è –º–µ–∂–¥—É –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–º–∏, –Ω–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –Ω–∏–∫–∞–∫–∏—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–∏–∫–∞–∫–∏—Ö –∏—Å–∫–∞–∂–µ–Ω–∏–π –ª–∏—Ü–∞, –Ω–∏–∫–∞–∫–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.',
    referenceImage: '/img/newyear.jpeg' // –ü—É—Ç—å –∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—É
  }
]

function App() {
  const [selectedPhoto, setSelectedPhoto] = useState(null)
  const [selectedStyle, setSelectedStyle] = useState(CARD_STYLES[0])
  const [isGenerating, setIsGenerating] = useState(false)
  const [generatedCard, setGeneratedCard] = useState(null)
  const [error, setError] = useState(null)

  useEffect(() => {
    initTelegramWebApp()
  }, [])

  const handlePhotoSelect = (file) => {
    setSelectedPhoto(file)
    setGeneratedCard(null)
    setError(null)
  }

  const handleStyleSelect = (style) => {
    setSelectedStyle(style)
    setGeneratedCard(null)
    setError(null)
  }

  const handleGenerate = async () => {
    if (!selectedPhoto) {
      setError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é')
      return
    }

    setIsGenerating(true)
    setError(null)
    setGeneratedCard(null)

    try {
      const result = await generateCard(selectedPhoto, selectedStyle)
      setGeneratedCard(result)
    } catch (err) {
      setError(err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∫–∏')
      console.error('Generation error:', err)
    } finally {
      setIsGenerating(false)
    }
  }

  return (
    <div className="app">
      <div className="container">
        <h1 className="title">üé¥ –§–æ—Ç–æ-–û—Ç–∫—Ä—ã—Ç–∫–∏</h1>
        <p className="subtitle">–°–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—É—é –æ—Ç–∫—Ä—ã—Ç–∫—É —Å –≤–∞—à–µ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π</p>

        <PhotoUploader 
          onPhotoSelect={handlePhotoSelect}
          selectedPhoto={selectedPhoto}
        />

        <StyleSelector
          styles={CARD_STYLES}
          selectedStyle={selectedStyle}
          onStyleSelect={handleStyleSelect}
        />

        <GenerateButton
          onClick={handleGenerate}
          disabled={!selectedPhoto || isGenerating}
        />

        {error && (
          <div className="error-message">
            {error}
          </div>
        )}

        {isGenerating && <LoadingSpinner />}

        {generatedCard && (
          <ResultCard
            imageUrl={generatedCard}
            onDownload={async () => {
              try {
                console.log('–ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', generatedCard)
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ
                const response = await fetch(generatedCard, {
                  mode: 'cors',
                  credentials: 'omit'
                })
                
                if (!response.ok) {
                  throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} ${response.statusText}`)
                }
                
                const blob = await response.blob()
                console.log('Blob —Å–æ–∑–¥–∞–Ω, —Ä–∞–∑–º–µ—Ä:', blob.size, '—Ç–∏–ø:', blob.type)
                
                if (blob.size === 0) {
                  throw new Error('–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª')
                }
                
                const url = window.URL.createObjectURL(blob)
                const link = document.createElement('a')
                link.href = url
                link.download = `photo-card-${Date.now()}.png`
                document.body.appendChild(link)
                link.click()
                document.body.removeChild(link)
                window.URL.revokeObjectURL(url)
              } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error)
                alert(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.`)
                // Fallback: –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                window.open(generatedCard, '_blank')
              }
            }}
          />
        )}
      </div>
    </div>
  )
}

export default App

